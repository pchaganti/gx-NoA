<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoA | Free Deep Think</title>
    <!-- ADDED: Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0E1117;
            --secondary-color: #262730;
            --accent-color: #FF4B4B;
            --text-color: #FAFAFA;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --border-radius: 0.5rem;
        }
        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 2rem;
            font-size: 16px;
            line-height: 1.6;
        }
        h1, h2 {
            color: var(--text-color);
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            border-bottom: none;
        }
        h2 {
            font-size: 1.75rem;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--primary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .section {
            background-color: var(--secondary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .hidden {
            display: none;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input, textarea, button, select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--secondary-color);
            background-color: #1C1E25;
            color: var(--text-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 75, 75, 0.3);
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        button {
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--text-color);
            font-weight: bold;
            border: none;
            transition: background-color: 0.3s ease;
        }
        button:hover:not(:disabled) {
            background-color: #E03C3C;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #log-container {
            height: 400px;
            background-color: #000;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            overflow-y: scroll;
            font-family: 'Menlo', 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            color: #C0C0C0;
            white-space: pre-wrap;
        }
        /* MODIFIED: Terminal-like style for ASCII graph display */
        #graph-container {
            min-height: 400px;
            background-color: #000;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Menlo', 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            color: #C0C0C0;
            white-space: pre;
        }
        #graph-container p {
            color: #888;
            white-space: pre-wrap; /* Allow placeholder text to wrap */
        }
        .mbti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            background-color: #1C1E25;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }
        .mbti-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mbti-option input[type="checkbox"] {
            width: auto;
            margin-bottom: 0;
        }
        .mbti-option label {
            margin-bottom: 0;
            font-weight: normal;
        }
        #results-container pre, #hidden-outputs-container pre, #papers-container pre {
            background-color: #000;
            padding: 1rem;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .header-with-button h2, .header-with-button h3 {
            border-bottom: none;
            padding-bottom: 0;
            margin: 0;
        }
        #download-log-button, .download-paper-button, #download-report-button {
            width: auto;
            padding: 0.5rem 1rem;
            margin-bottom: 0;
            font-size: 0.9rem;
            background-color: var(--secondary-color);
        }
        #download-log-button:hover:not(:disabled), .download-paper-button:hover:not(:disabled), #download-report-button:hover:not(:disabled) {
            background-color: #3a3b44;
        }

    </style>
</head>
<body>
    <h1>It takes a village of agents to raise an agent</h1>

    <div class="container">
        <div id="graph-architecture" class="section">
            <h2>Graph Architecture</h2>
            <form id="graph-params-form">
                <label for="llm_provider">LLM Provider:</label>
                <select id="llm_provider" name="llm_provider">
                    <option value="Gemini">Google Gemini</option>
                    <option value="Ollama">Local Ollama</option>
                </select>
                <div class="mbti-option" style="margin-bottom: 1rem; margin-top: 0.5rem;">
                    <input type="checkbox" id="debug_mode" name="debug_mode" value="true">
                    <label for="debug_mode">ðŸš€ Enable Debug Mode (Uses Instant Mock LLM)</label>
                </div>
                <div id="ollama-model-section" class="hidden">
                    <label for="ollama_model">Ollama Model Name:</label>
                    <input type="text" id="ollama_model" name="ollama_model" value="dengcao/Qwen3-30B-A3B-Instruct-2507:latest">
                </div>
                <label for="cot_trace_depth">CoT trace depth (max 32):</label>
                <input type="number" id="cot_trace_depth" name="cot_trace_depth" value="2" max="32" min="2" required>
                <label for="num_questions">Number of questions for final report (5-100):</label>
                <input type="number" id="num_questions" name="num_questions" value="25" min="5" max="100" required>
                <label for="num_epochs">Number of epochs:</label>
                <input type="number" id="num_epochs" name="num_epochs" value="1" required>
                <label for="vector_word_size">Vector word size (Number of verbs per agent):</label>
                <input type="number" id="vector_word_size" name="vector_word_size" value="2" min="2" max="20" required>
                <label for="prompt_alignment">Prompt alignment (0.1-2.0):</label>
                <input type="number" id="prompt_alignment" name="prompt_alignment" step="0.1" min="0.1" max="2.0" value="1.0" required>
                <label for="density">Density (0.1-2.0):</label>
                <input type="number" id="density" name="density" step="0.1" min="0.1" max="2.0" value="1.0" required>
                <label for="learning_rate">Learning rate (0.1-2.0):</label>
                <input type="number" id="learning_rate" name="learning_rate" step="0.1" min="0.1" max="2.0" value="0.1" required>
                <label>MBTI Archetypes (select at least 2):</label>
                <div class="mbti-grid">
                    <div class="mbti-option"><input type="checkbox" id="mbti-istj" name="mbti_archetypes" value="ISTJ" checked><label for="mbti-istj">ISTJ (Inspector)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-isfj" name="mbti_archetypes" value="ISFJ" checked><label for="mbti-isfj">ISFJ (Protector)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-infj" name="mbti_archetypes" value="INFJ"><label for="mbti-infj">INFJ (Advocate)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-intj" name="mbti_archetypes" value="INTJ"><label for="mbti-intj">INTJ (Architect)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-istp" name="mbti_archetypes" value="ISTP"><label for="mbti-istp">ISTP (Virtuoso)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-isfp" name="mbti_archetypes" value="ISFP"><label for="mbti-isfp">ISFP (Adventurer)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-infp" name="mbti_archetypes" value="INFP"><label for="mbti-infp">INFP (Mediator)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-intp" name="mbti_archetypes" value="INTP"><label for="mbti-intp">INTP (Logician)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-estp" name="mbti_archetypes" value="ESTP"><label for="mbti-estp">ESTP (Entrepreneur)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-esfp" name="mbti_archetypes" value="ESFP"><label for="mbti-esfp">ESFP (Entertainer)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-enfp" name="mbti_archetypes" value="ENFP"><label for="mbti-enfp">ENFP (Campaigner)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-entp" name="mbti_archetypes" value="ENTP"><label for="mbti-entp">ENTP (Debater)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-estj" name="mbti_archetypes" value="ESTJ"><label for="mbti-estj">ESTJ (Executive)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-esfj" name="mbti_archetypes" value="ESFJ"><label for="mbti-esfj">ESFJ (Consul)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-enfj" name="mbti_archetypes" value="ENFJ"><label for="mbti-enfj">ENFJ (Protagonist)</label></div>
                    <div class="mbti-option"><input type="checkbox" id="mbti-entj" name="mbti_archetypes" value="ENTJ"><label for="mbti-entj">ENTJ (Commander)</label></div>
                </div>
                <label for="prompt">Prompt:</label>
                <textarea id="prompt" name="prompt" required>Is there a singular, all-encompassing, coherent theoretical framework of physics that fully explains and links together all physical aspects of the universe? Design one.</textarea>
                <button type="submit" id="run-button">Build and Run Graph</button>
            </form>
        </div>
    </div>
    <!-- NEW: Container for Perplexity Chart -->
    <div class="container hidden" id="perplexity-chart-container">
        <h2>Average Perplexity per Epoch</h2>
        <canvas id="perplexityChart"></canvas>
    </div>
    <div class="container">
        <div class="header-with-button">
            <h2>Real-time Graph Activity</h2>
            <button id="download-log-button" disabled>Download Full Log</button>
        </div>
        <div id="log-container"></div>
    </div>
    <div class="container">
        <h2>Graph Visualization</h2>
        <div id="graph-container">
            <p>ASCII graph will be displayed here after the process starts...</p>
        </div>
    </div>
    <!-- NEW: Container for final report download -->
    <div class="container hidden" id="report-container">
        <h2>Final Report</h2>
        <p>The graph execution is complete. The generated academic papers have been compiled into a single zip archive for you to download.</p>
        <button id="download-report-button">Download Full Report (.zip)</button>
    </div>


<script>
    function parseJsonFromDataString(inputString) {
      const jsonString = inputString.slice(5, inputString.length);
      try {
        const dataObject = JSON.parse(jsonString);
        return dataObject;
      } catch (error) {
        console.error("Failed to parse JSON from the extracted string:", error);
        console.error("Problematic string was:", jsonString);
        return null;
      }
    }
    const graphParamsForm = document.getElementById('graph-params-form');
    const runButton = document.getElementById('run-button');
    const logContainer = document.getElementById('log-container');
    const graphContainer = document.getElementById('graph-container');
    const llmProviderSelect = document.getElementById('llm_provider');
    const ollamaModelSection = document.getElementById('ollama-model-section');
    const debugModeCheckbox = document.getElementById('debug_mode');
    const downloadLogButton = document.getElementById('download-log-button');
    const reportContainer = document.getElementById('report-container');
    const downloadReportButton = document.getElementById('download-report-button');
    const perplexityChartContainer = document.getElementById('perplexity-chart-container');
    const perplexityChartCanvas = document.getElementById('perplexityChart').getContext('2d');

    let fullLogContent = '';
    let perplexityChart = null;
    let allPerplexityValues = [];
    let allLbelsData = [];

    llmProviderSelect.addEventListener('change', (e) => {
        ollamaModelSection.classList.toggle('hidden', e.target.value !== 'Ollama');
    });

    debugModeCheckbox.addEventListener('change', (e) => {
        const isDebug = e.target.checked;
        llmProviderSelect.disabled = isDebug;
        ollamaModelSection.classList.toggle('hidden', isDebug || llmProviderSelect.value !== 'Ollama');
    });

    const addLogMessage = (text, options = {}) => {
        fullLogContent += text + '\n';
        // Use <pre> for JSON to preserve formatting
        const container = (text.trim().startsWith('{') && text.trim().endsWith('}')) ? document.createElement('pre') : document.createElement('p');
        container.style.margin = '0';
        container.style.lineHeight = '1.4';


        if (options.isHTML) container.innerHTML = text;
        else container.textContent = text;
        
        if (options.color) container.style.color = options.color;

        logContainer.appendChild(container);
        logContainer.scrollTop = logContainer.scrollHeight;
    };
    
    const downloadLog = () => {
        const blob = new Blob([fullLogContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        a.download = `noa-run-log-${timestamp}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    downloadLogButton.addEventListener('click', downloadLog);

    const renderPerplexityChart = () => {
        if (perplexityChart) {
            perplexityChart.destroy();
        }
        const labels = allLbelsData;
        const data = allPerplexityValues; 

        perplexityChartContainer.classList.remove('hidden');
        perplexityChart = new Chart(perplexityChartCanvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Agent Perplexity',
                    data: data,
                    borderColor: 'rgba(255, 75, 75, 1)',
                    backgroundColor: 'rgba(255, 75, 75, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Perplexity Score' }
                    },
                    x: {
                         title: { display: true, text: 'Epoch' }
                    }
                }
            }
        });
    };

    graphParamsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(graphParamsForm);
        const params = {};
        formData.forEach((value, key) => {
            if (key === 'mbti_archetypes') {
                if (!params[key]) params[key] = [];
                params[key].push(value);
            } else {
                params[key] = value;
            }
        });
        
        if (!formData.has('debug_mode')) {
            params.debug_mode = 'false';
        }

        if (!params.mbti_archetypes || params.mbti_archetypes.length < 2) {
            alert('Please select at least 2 MBTI archetypes.');
            return;
        }
        runButton.disabled = true;
        downloadLogButton.disabled = true;
        runButton.textContent = 'Processing...';
        logContainer.innerHTML = ''; 
        fullLogContent = '';
        graphContainer.innerHTML = '<p>ASCII graph will be displayed here after the process starts...</p>';
        reportContainer.classList.add('hidden');
        perplexityChartContainer.classList.add('hidden');
        allPerplexityValues = [];
        allLbelsData = [];


        addLogMessage('Sending request to build and run graph...');
        try {
            const response = await fetch('/build_and_run_graph', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ params })
            });
            const result = await response.json();
            if (!response.ok) {
                addLogMessage(`Error: ${result.message}`, { color: 'red' });
                if(result.traceback) {
                    const pre = document.createElement('pre');
                    pre.style.color = '#ff8c8c';
                    pre.textContent = result.traceback;
                    logContainer.appendChild(pre);
                }
                return;
            }
            addLogMessage(`<strong>âœ… ${result.message}</strong>`, { isHTML: true, color: 'lime' });

            if (result.session_id) {
                addLogMessage(`Report generated successfully. Session ID: ${result.session_id}`, { color: 'cyan' });
                reportContainer.classList.remove('hidden');
                downloadReportButton.onclick = () => {
                    window.location.href = `/download_report/${result.session_id}`;
                };
            } else {
                 addLogMessage(`âš ï¸ Server finished but no downloadable report was generated.`, { color: 'orange' });
            }

        } catch (error) {
            addLogMessage(`A client-side error occurred: ${error.message}`, { color: 'red' });
        } finally {
            runButton.disabled = false;
            downloadLogButton.disabled = false;
            runButton.textContent = 'Build and Run Graph';
        }
    });

    const eventSource = new EventSource('/stream_log');

    eventSource.onmessage = async function(event) {
        const rawMessage = event.data;
        
        if (rawMessage.includes('__start__')) {
            graphContainer.textContent = rawMessage.replace('__start__', '');
            addLogMessage(">>> ASCII Graph Rendered <<<", { color: 'cyan' });
        } else if (rawMessage.includes('perplexity') && rawMessage.includes('epoch')) {
            const newPerplexityObject = parseJsonFromDataString(rawMessage);
            if (newPerplexityObject) {
                addLogMessage(`>>> Perplexity data received for epoch ${newPerplexityObject.epoch}: ${newPerplexityObject.perplexity.toFixed(2)}`, { color: 'cyan' });
                allPerplexityValues.push(parseFloat(newPerplexityObject.perplexity));
                allLbelsData.push(newPerplexityObject.epoch);
                renderPerplexityChart();
            }
        } else {
            addLogMessage(rawMessage);
        }
    }; 

    eventSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        addLogMessage("Error: Connection to server log stream lost. Please refresh and try again.", { color: 'red' });
        eventSource.close();
    };
</script>
</body>
</html>